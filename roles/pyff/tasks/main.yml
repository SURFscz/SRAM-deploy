---
- name: Ensure that packages are installed
  apt:
    name:
      - git
      - xmlsec1
    state: present

- name: create pyFF user
  user:
    name: pyff
    shell: "/bin/false"
    state: present

- name: Create project directory
  file:
    path: "{{ pyff_project_dir }}"
    state: directory
    mode: 0755
    owner: pyff

- name: Create metadata directory
  file:
    path: "{{ pyff_metadata_dir }}"
    state: directory
    mode: 0755
    owner: pyff

# requirements.txt can be generated from virtualenv/bin/pip freeze
- name: Generate requirements.txt.j2 from template
  template:
    src: "requirements.txt.j2"
    dest: "{{ pyff_project_dir }}/requirements.txt"

- name: Create python3 virtualenv
  import_role:
    name: "python-venv"
  vars:
    python_venv_dir: "{{ pyff_env_dir }}"
    python_venv_requirements: "{{ pyff_project_dir }}/requirements.txt"
    python_venv_user: "pyff"
  notify: "pyff changed"

- name: Create certs directory
  file:
    path: "{{pyff_cert_dir}}"
    state: "directory"
    owner: "pyff"
    mode: "0755"

- name: create self-signed Metadata Signing SSL certs
  shell: >
    openssl genrsa -out "{{pyff_cert_dir}}/{{ item }}.key" 2048;
    openssl req -new -nodes -x509 -subj "/C=NL/CN={{ item }}"
    -days 3650 -key "{{pyff_cert_dir}}/{{ item }}.key"
    -out "{{pyff_cert_dir}}/{{ item }}.crt" -extensions v3_ca
  args:
    creates: "{{pyff_cert_dir}}/{{ item }}.crt"
  with_items:
    - signing
  become: true
  become_user: "pyff"
  notify: "pyff changed"
  when: metadata_signing_cert is not defined

- name: write fixed Metadata signing certificates
  copy:
    dest: "{{pyff_cert_dir}}/{{ item.file }}"
    content: "{{item.contents}}"
    owner: pyff
    mode: "{{item.mode}}"
  with_items:
    - { file: "signing.key", mode: "0600", contents: "{{metadata_signing_cert.priv}}" }
    - { file: "signing.crt", mode: "0644", contents: "{{metadata_signing_cert.pub}}"  }
  notify: "pyff changed"
  when: metadata_signing_cert is defined
