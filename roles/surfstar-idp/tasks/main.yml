---

#########################################################
## Demop app
#########################################################
- name: Create html dir
  file:
    path: "{{surfstar_idp_html_dir}}"
    state: "directory"
    mode: "0755"

#########################################################
## SAML IdP
#########################################################
- include_role:
    name: "simplesamlphp"
    public: true

- name: SimpleSaml configuration (templates)
  template:
    src: "{{item}}.j2"
    dest: "{{ simplesaml_project_dir }}/config/{{item}}"
  with_items:
    - "saml20-idp-hosted.php"

- name: SimpleSaml configuration (copy)
  copy:
    src: "{{item}}"
    dest: "{{ simplesaml_project_dir }}/config/{{item}}"
  with_items:
    - "saml20-sp-remote.php"

- name: Link SimpleSaml configuration
  file:
    src: "{{ simplesaml_project_dir }}/config/{{item.key}}"
    path: "{{ simplesaml_project_dir }}/simplesaml/{{item.value}}/{{item.key}}"
    state: "link"
    force: true
  with_dict:
    saml20-idp-hosted.php: "metadata"
    saml20-idp-remote.php: "metadata"
    saml20-sp-remote.php: "metadata"

- name: Install SAML signing certificate
  copy:
    content: "{{ item.contents }}"
    dest: "{{ simplesaml_cert_dir }}/{{ item.file }}"
    mode: "0640"
    owner: "root"
    group: "{{testidp_group}}"
  loop:
    - { file: "saml.key", contents: "{{ surfstar_idp_samlcert.key}}"  }
    - { file: "saml.crt", contents: "{{ surfstar_idp_samlcert.cert}}" }

#########################################################
## Install RemoteUserSSL module
#########################################################
- name: Find RemoteUserSSL repository
  ansible.builtin.command:
    cmd: jq .repositories.remoteuserssl composer.json
    chdir: "{{ simplesaml_project_dir }}/simplesaml"
  register: repo
  changed_when: false

- name: Add RemoteUserSSL repo to composer.json
  ansible.builtin.command:
    cmd: >-
      composer config repositories.remoteuserssl
      vcs https://github.com/SURFscz/remoteuserssl.git
    chdir: "{{ simplesaml_project_dir }}/simplesaml"
  environment:
    COMPOSER_ALLOW_SUPERUSER: 1
  when: "repo.stdout == 'null'"

- name: Require RemoteUserSSL module
  ansible.builtin.command:
    cmd: "composer require local/simplesamlphp-module-remoteuserssl @dev"
    chdir: "{{ simplesaml_project_dir }}/simplesaml"
    creates: "{{ simplesaml_project_dir }}/simplesaml/modules/remoteuserssl"
  environment:
    COMPOSER_ALLOW_SUPERUSER: 1

#########################################################
## nginx
#########################################################
- include_role:
    name: "nginx"

- include_role:
    name: "letsencrypt"
    public: true
  vars:
    letsencrypt_staging: false
    letsencrypt_hosts: [ "{{surfstar_idp_hostname}}" ]

- name: Install nginx config
  template:
    src: "nginx.conf.j2"
    dest: "/etc/nginx/sites-enabled/01-sram-testidp-ssl.conf"
  notify: "restart nginx"

- name: Restart nginx after certificate rollover
  copy:
    content: |
      #!/bin/sh
      echo "restarting nginx"
      /usr/bin/systemctl reload nginx.service
      exit 0
    dest: "{{letsencrypt_hooks}}/sram-nginx.sh"
    mode: "0755"

