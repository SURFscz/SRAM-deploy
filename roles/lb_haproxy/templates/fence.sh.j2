{% set lb_ldap = loadbalancer|selectattr("protocol", "equalto", "ldap")|list %}
#!/bin/bash
{% for host in lb_ldap %}
{% set name = host.hostname.split('.')[0] -%}
echo "enable frontend ldap_{{name}}_{{host.frontend_port}}" | socat stdio /run/haproxy/admin.sock
{% endfor %}

TARGET="{{ groups['ldap'] | join(' ') }}"
MAXFAIL=0

COUNTER=0
while : ; do
  fping ${TARGET} &>/dev/null
  if [ $? -ne 0 ]; then
    COUNTER=$((COUNTER+1))
    if [ $COUNTER -gt ${MAXFAIL} ]; then
{% for host in lb_ldap %}
{% set name = host.hostname.split('.')[0] %}
      echo "disable frontend ldap_{{name}}_{{host.frontend_port}}" | socat stdio /run/haproxy/admin.sock
{% endfor %}
      break
    fi
  else
    COUNTER=0
  fi
  #echo ${COUNTER}
  sleep 1;
done
