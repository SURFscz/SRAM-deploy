---
- include_role:
    name: "simplesamlphp"
    public: true
  vars:
    simplesaml_name: "{{demosp_name}}"
    simplesaml_user: "{{demosp_user}}"
    simplesaml_group: "{{demosp_group}}"

- name: install SSP config
  template:
    src: "{{item}}.j2"
    dest: "{{simplesaml_project_dir}}/config/{{item}}"
    mode: "0755"
  with_items:
    - "authsources.php"
    - "saml20-idp-remote.php"

- name: Generate a SAML signing certificate
  command:
    cmd: >
      openssl req -x509 -newkey rsa:2048 -sha256 -days 36500 -nodes
              -keyout saml.key -out saml.pem
              -subj '/CN=simpelsamlphp/'
    chdir: "{{simplesaml_cert_dir}}"
    creates: "{{simplesaml_cert_dir}}/saml.pem"

- name: Set permissions for keys
  file:
    path: "{{simplesaml_cert_dir}}/saml.key"
    mode: "0640"
    group: "{{demosp_group}}"

- name: install EduTeams certs
  copy:
    src: "{{item}}"
    dest: "{{simplesaml_cert_dir}}/{{item}}"
  with_items:
    - "eduteams-prd.pem"
    - "eduteams-acc.pem"

- include_role:
    name: "nginx"

- include_role:
    name: "letsencrypt"
    public: true
  vars:
    letsencrypt_staging: false
    letsencrypt_hosts: [ "demo-sp.sram.surf.nl" ]


- name: Install nginx config
  template:
    src: "nginx.conf.j2"
    dest: "/etc/nginx/sites-enabled/01-sram-demosp.conf"
  notify: "restart nginx"

- name: Restart nginx after certificate rollover
  copy:
    content: |
      #!/bin/sh
      echo "restarting nginx"
      /usr/bin/systemctl reload nginx.service
      exit 0
    dest: "{{letsencrypt_hooks}}/sram-nginx.sh"
    mode: "0755"

