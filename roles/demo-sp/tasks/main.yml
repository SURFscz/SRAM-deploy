---
- include_role:
    name: "simplesamlphp"
    public: true
  vars:
    simplesaml_name: "{{demosp_name}}"
    simplesaml_user: "{{demosp_user}}"
    simplesaml_group: "{{demosp_group}}"

- include_role:
    name: "nginx"

- include_role:
    name: "letsencrypt"
    public: true
  vars:
    letsencrypt_staging: false
    letsencrypt_hosts: [ "demo-sp.sram.surf.nl" ]

- name: Install nginx config
  template:
    src: "nginx.conf.j2"
    dest: "/etc/nginx/sites-enabled/01-sram-demosp.conf"
  notify: "restart nginx"

- name: Restart nginx after certificate rollover
  copy:
    content: |
      #!/bin/sh
      echo "restarting nginx"
      /usr/bin/systemctl reload nginx.service
      exit 0
    dest: "{{letsencrypt_hooks}}/sram-nginx.sh"
    mode: "0755"

